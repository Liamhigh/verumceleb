# Verum Omnis - AI Coding Agent Instructions

## Snapshot
- Firebase monorepo rooted in `verum-omnis-founders-gift-v5/verum-omnis-monorepo`; pillars: `functions/` (Node 20 Express API), `web/` (static bundle), `capacitor-app/` (Capacitor shell).
- API ships as `api2` HTTPS function; `firebase.json` rewrites `/api/**` to it so local calls hit the emulator at `http://localhost:5000/api/v1/...`.

## Immutable Governance
- `functions/assets/rules/` and `functions/assets/treaty/` are SHA-512 locked via `manifest.json`; `functions/index.js` verifies every cold start and blocks unknown files.
- Only update rule artifacts by regenerating hashes and manifest together—casual edits fail deploys and violate the constitutional workflow.
- `makeSealedPdf` expects `web/assets/logo.png`; add the asset before invoking `/v1/seal` or batch seal scripts.

## Runtime Behavior
- Express routes: `/v1/verify`, `/v1/contradict` (stub), `/v1/anchor`, `/v1/seal`; responses always include `{ ok: boolean }` and receipts flow through `receipts-kv.js` (Firestore if creds load, Map fallback).
- `/v1/seal` streams a temp PDF from `/tmp`; keep processing lightweight so the stream finish handler can unlink promptly.
- Video endpoints exist but return 501 until `config.video.json` flips flags and the modules in `functions/video/` gain real implementations.

## Local Workflows
- From `functions/`: run `npm ci`; start emulators from monorepo root with `firebase emulators:start`; issue POSTs to `/api/v1/...` for manual tests.
- Generate sample seals with `node test-generate-pdf.js` (single) or `node generate-batch-seals.js` (bulk plus `seals/forensics.json`).
- Capacitor loop: `cd capacitor-app && npm install`, `npm run build`, `npx cap sync`, then `npx cap run android|ios`; build copies `web/` output into `capacitor-app/www/`.

## Patterns & Gotchas
- All runtime code uses ES modules; keep imports explicit and avoid CommonJS.
- `receipts-kv.js` auto-inits firebase-admin; provide service creds or emulator config to persist receipts, otherwise expect volatile Map storage.
- Logging relies on `pino` (`log.info`) for cold-start status; check deploy logs when the immutable pack fails.
- Treat the system as stateless—no durable filesystem writes beyond temporary PDFs and the optional `seals/forensics.json` generated by tooling.
