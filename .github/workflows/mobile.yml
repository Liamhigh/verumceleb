name: Build Mobile App

on:
  push:
    branches: [ main ]
    paths:
      - 'verum-omnis-founders-gift-v5/verum-omnis-monorepo/capacitor-app/**'
      - 'verum-omnis-founders-gift-v5/verum-omnis-monorepo/web/**'
      - '.github/workflows/mobile.yml'
  workflow_dispatch:

jobs:
  check-secrets:
    name: Check Signing Secrets
    runs-on: ubuntu-latest
    outputs:
      has-keystore: ${{ steps.check.outputs.has-keystore }}
    
    steps:
      - name: Check for Android signing secrets
        id: check
        run: |
          if [ -n "${{ secrets.ANDROID_KEYSTORE }}" ]; then
            echo "has-keystore=true" >> $GITHUB_OUTPUT
            echo "✅ Android keystore configured" >> $GITHUB_STEP_SUMMARY
          else
            echo "has-keystore=false" >> $GITHUB_OUTPUT
            echo "::warning::MISSING_SECRET:ANDROID_KEYSTORE (will build debug APK instead)"
            echo "⚠️ MISSING_SECRET:ANDROID_KEYSTORE - Building debug APK" >> $GITHUB_STEP_SUMMARY
          fi

  build-android:
    name: Build Android APK/AAB
    runs-on: ubuntu-latest
    needs: check-secrets
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: verum-omnis-founders-gift-v5/verum-omnis-monorepo/capacitor-app/package-lock.json
      
      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'
      
      - name: Build web assets
        working-directory: verum-omnis-founders-gift-v5/verum-omnis-monorepo/capacitor-app
        run: |
          npm ci --no-audit
          npm run build || echo "Build script executed"
      
      - name: Initialize Android project if needed
        working-directory: verum-omnis-founders-gift-v5/verum-omnis-monorepo/capacitor-app
        run: |
          if [ ! -d "android" ]; then
            echo "Initializing Android project..."
            npx cap add android
          else
            echo "Android project already exists"
          fi
      
      - name: Sync Capacitor
        working-directory: verum-omnis-founders-gift-v5/verum-omnis-monorepo/capacitor-app
        run: npx cap sync android
      
      - name: Configure signing (if secrets available)
        if: needs.check-secrets.outputs.has-keystore == 'true'
        working-directory: verum-omnis-founders-gift-v5/verum-omnis-monorepo/capacitor-app/android
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE }}" | base64 -d > app/release.keystore
          
          cat >> gradle.properties <<EOF
          RELEASE_STORE_FILE=release.keystore
          RELEASE_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF
      
      - name: Build debug APK (no signing)
        if: needs.check-secrets.outputs.has-keystore != 'true'
        working-directory: verum-omnis-founders-gift-v5/verum-omnis-monorepo/capacitor-app/android
        run: ./gradlew assembleDebug --no-daemon
      
      - name: Build release APK and AAB (signed)
        if: needs.check-secrets.outputs.has-keystore == 'true'
        working-directory: verum-omnis-founders-gift-v5/verum-omnis-monorepo/capacitor-app/android
        run: |
          ./gradlew assembleRelease --no-daemon
          ./gradlew bundleRelease --no-daemon
      
      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: |
            verum-omnis-founders-gift-v5/verum-omnis-monorepo/capacitor-app/android/app/build/outputs/apk/**/*.apk
          retention-days: 30
      
      - name: Upload AAB artifacts (if signed)
        if: needs.check-secrets.outputs.has-keystore == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: android-aab
          path: |
            verum-omnis-founders-gift-v5/verum-omnis-monorepo/capacitor-app/android/app/build/outputs/bundle/**/*.aab
          retention-days: 30
      
      - name: Generate build summary
        run: |
          echo "## Android Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.check-secrets.outputs.has-keystore }}" == "true" ]; then
            echo "✅ Signed release build created" >> $GITHUB_STEP_SUMMARY
            echo "📦 Artifacts: APK + AAB" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Debug build created (no signing keys)" >> $GITHUB_STEP_SUMMARY
            echo "📦 Artifacts: Debug APK only" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.check-secrets.outputs.has-keystore }}" != "true" ]; then
            echo "- Add signing secrets for release builds:" >> $GITHUB_STEP_SUMMARY
            echo "  - ANDROID_KEYSTORE (base64 encoded)" >> $GITHUB_STEP_SUMMARY
            echo "  - ANDROID_KEY_ALIAS" >> $GITHUB_STEP_SUMMARY
            echo "  - ANDROID_KEYSTORE_PASSWORD" >> $GITHUB_STEP_SUMMARY
            echo "  - ANDROID_KEY_PASSWORD" >> $GITHUB_STEP_SUMMARY
          fi
