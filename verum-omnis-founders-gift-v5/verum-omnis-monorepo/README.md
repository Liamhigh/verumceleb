# Verum Omnis - Immutable Rules System

This repository implements a strict immutability system for rules and treaties to ensure integrity and prevent unauthorized modifications.

## 🔒 Immutable Files

The following directories contain immutable files:
- `functions/assets/rules/` - Rule files that define the system behavior
- `functions/assets/treaty/` - Treaty documents (PDF and YAML)

These files are protected by a cryptographic manifest system that tracks SHA-512 hashes and file sizes.

## 📋 Manifest System

The manifest file (`functions/assets/rules/manifest.json`) contains:
- SHA-512 hash of each immutable file
- File size for quick verification
- Version information

**⚠️ CRITICAL: The manifest should NEVER be manually edited. It must only be generated by the `generate-manifest` script.**

## 🛠️ Commands

### Verify Integrity

Check that all immutable files match the manifest:

```bash
npm run verify-immutable
```

This command:
- Verifies SHA-512 hashes of all files
- Checks for unexpected files not in the manifest
- Ensures no files are missing

### Generate Manifest

After making authorized changes to rules or treaties, regenerate the manifest:

```bash
npm run generate-manifest
```

This command:
- Scans all files in `functions/assets/rules/` (excluding manifest.json and CHANGELOG)
- Scans all files in `functions/assets/treaty/`
- Computes SHA-512 hashes and sizes
- Generates a new manifest.json

**Remember to commit both the changed files AND the updated manifest!**

## 🔐 Protection Mechanisms

### 1. GitHub Actions CI/CD

Every pull request and push to main that touches immutable files triggers automatic verification:
- Checks file hashes against manifest
- Fails loudly if mismatches are detected
- Prevents unauthorized changes from being merged

See: `.github/workflows/immutable-rules-check.yml`

### 2. Pre-commit Hooks (Local)

Husky pre-commit hooks automatically verify integrity before committing:
- Runs when you commit changes to immutable files
- Prevents commits if verification fails
- Reminds you to run `generate-manifest` if needed

To install hooks (run once after cloning):

```bash
npm install
```

### 3. Manual Verification

Run verification anytime:

```bash
npm run verify-immutable
```

## 📝 Workflow for Modifying Rules

1. **Make your changes** to rule or treaty files
2. **Generate new manifest**: `npm run generate-manifest`
3. **Verify integrity**: `npm run verify-immutable`
4. **Commit both** the file changes and updated manifest
5. **Push** - CI will automatically verify

## ⚠️ Common Issues

### "Hash mismatch" error

**Problem**: File content doesn't match the manifest hash.

**Solution**: 
- If you made intentional changes: Run `npm run generate-manifest`
- If you didn't make changes: The file may have been corrupted or tampered with

### "Unexpected files" error

**Problem**: Files exist that aren't in the manifest.

**Solution**: Run `npm run generate-manifest` to add them to the manifest.

### "Manifest manually edited" warning

**Problem**: The manifest was edited directly instead of being generated.

**Solution**: 
1. Restore the correct manifest from git history
2. Make your file changes
3. Run `npm run generate-manifest`

## 🏗️ Architecture

```
verum-omnis-monorepo/
├── .github/
│   └── workflows/
│       └── immutable-rules-check.yml  # CI/CD verification
├── .husky/
│   └── pre-commit                      # Local git hook
├── scripts/
│   ├── verify-immutable-pack.mjs       # Verification script
│   └── generate-manifest.mjs           # Manifest generation
└── functions/
    └── assets/
        ├── rules/
        │   ├── manifest.json            # Cryptographic manifest
        │   ├── 01_constitution.json
        │   ├── 02_contradiction_engine.yaml
        │   └── ...                      # Other rule files
        └── treaty/
            ├── Guardianship_Treaty_Verum_Omnis_Founders.pdf
            └── Guardianship_Treaty_Verum_Omnis_Founders.yaml
```

## 🔍 How It Works

1. **Manifest Generation**: The `generate-manifest` script computes SHA-512 hashes and sizes for all immutable files and stores them in `manifest.json`.

2. **Local Verification**: The `verify-immutable-pack` script reads the manifest and verifies each file's hash and size match.

3. **Pre-commit Hook**: Husky intercepts git commits and runs verification if immutable files changed.

4. **CI/CD Verification**: GitHub Actions runs verification on every PR/push, ensuring no unauthorized changes slip through.

## 🎯 Design Principles

- **Cryptographic Integrity**: SHA-512 hashes ensure even single-bit changes are detected
- **Immutability by Design**: Rules and treaties cannot be modified without regenerating the manifest
- **Fail Loudly**: Any mismatch causes immediate, visible failure
- **Defense in Depth**: Multiple layers (local hooks, CI/CD, manual checks)
- **Audit Trail**: Git history shows all manifest updates

## 🤝 Contributing

When contributing changes to immutable files:

1. Understand that these files are immutable by design
2. Have proper authorization for any changes
3. Follow the workflow above
4. Ensure both file changes AND manifest updates are committed together
5. Never manually edit the manifest

## 📚 Additional Resources

- See `functions/assets/rules/gift_rules_CHANGELOG.md` for rule change history
- Review `.github/workflows/immutable-rules-check.yml` for CI implementation details
- Check `scripts/` for implementation of verification logic
