<!doctype html><html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Verum Assistant</title><link rel="stylesheet" href="/assets/app.css"/></head>
<body>

<!-- Header -->
<header class="chat-header">
  <div class="container">
    <div style="display:flex;align-items:center;justify-content:space-between">
      <div style="display:flex;align-items:center;gap:12px">
        <img src="/assets/logo_white.png" alt="Verum" style="height:32px"/>
        <h1 style="margin:0;font-size:1.25rem">Verum Assistant</h1>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <button class="chat-btn-icon" onclick="toggleTheme()" title="Toggle theme" id="themeBtn">üåô</button>
        <button class="chat-btn-icon" onclick="exportConversation()" title="Export to PDF">üìÑ</button>
        <button class="chat-btn-icon" onclick="clearHistory()" title="Clear history">üóëÔ∏è</button>
        <a href="/" style="color:var(--muted);text-decoration:none">‚Üê Home</a>
      </div>
    </div>
  </div>
</header>

<!-- Chat Container -->
<div class="chat-container">
  <div class="chat-messages" id="messages">
    <div class="message assistant">
      <div class="message-avatar">
        <img src="/assets/logo_blue.png" alt="AI"/>
      </div>
      <div class="message-content">
        <strong>Verum AI</strong>
        <p>Hello! I'm your legal AI assistant. I can help you:</p>
        <ul>
          <li>Verify and seal documents with SHA-512 hashing</li>
          <li>Detect contradictions in statements</li>
          <li>Generate forensic PDF seals with QR codes</li>
          <li>Anchor receipts to blockchain</li>
        </ul>
        <p>Upload a document or ask me anything!</p>
      </div>
    </div>
  </div>
  
  <!-- Input Area -->
  <div class="chat-input-container">
    <div class="container">
      <div class="chat-input">
        <input type="file" id="fileInput" style="display:none" accept=".pdf,.png,.jpg,.jpeg,.txt,.doc,.docx" multiple/>
        <button class="chat-btn-icon" onclick="document.getElementById('fileInput').click()" title="Upload file">
          üìé
        </button>
        <button class="chat-btn-icon" id="voiceBtn" onclick="toggleVoiceInput()" title="Voice input">
          üé§
        </button>
        <input type="text" id="userInput" placeholder="Type a message or upload a document..." />
        <button class="chat-btn-send" onclick="sendMessage()">
          Send
        </button>
      </div>
      <div id="uploadedFiles" class="uploaded-files"></div>
    </div>
  </div>
</div>

<script>
// Use the direct Cloud Function URL since hosting rewrite isn't working
const PROJECT = 'verumdone';
const isLocal = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
const devBase = `http://127.0.0.1:5001/${PROJECT}/us-central1/api`;
const prodBase = `https://us-central1-${PROJECT}.cloudfunctions.net/api`;
window.VO_API_BASE = isLocal ? devBase : prodBase;

// Dev banner for local development
if (isLocal) {
  document.addEventListener('DOMContentLoaded', () => {
    const b = document.createElement('div');
    b.style.cssText = 'position:fixed;bottom:8px;right:8px;background:#111;border:1px solid #333;color:#eee;padding:6px 10px;border-radius:8px;font:12px/1.2 system-ui;z-index:9999;opacity:.9';
    b.textContent = 'VO DEV API: ' + window.VO_API_BASE;
    document.body.appendChild(b);
  });
}

// Backwards compatible alias
const BASE = window.VO_API_BASE;
const messagesContainer = document.getElementById('messages');
const userInput = document.getElementById('userInput');
const fileInput = document.getElementById('fileInput');
const uploadedFilesDiv = document.getElementById('uploadedFiles');
let uploadedFiles = [];
let conversationHistory = [];
let recognition = null;
let isListening = false;

// Load theme and conversation history
const savedTheme = localStorage.getItem('verumTheme') || 'dark';
document.documentElement.setAttribute('data-theme', savedTheme);
updateThemeButton();

const savedHistory = localStorage.getItem('verumConversation');
if (savedHistory) {
  try {
    conversationHistory = JSON.parse(savedHistory);
    restoreConversation();
  } catch(e) {
    console.error('Failed to restore conversation', e);
  }
}

function saveConversation() {
  localStorage.setItem('verumConversation', JSON.stringify(conversationHistory));
}

function restoreConversation() {
  // Clear welcome message first
  messagesContainer.innerHTML = '';
  conversationHistory.forEach(msg => {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${msg.isUser ? 'user' : 'assistant'}`;
    msgDiv.innerHTML = msg.html;
    messagesContainer.appendChild(msgDiv);
  });
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function clearHistory() {
  if (confirm('Clear entire conversation history?')) {
    conversationHistory = [];
    localStorage.removeItem('verumConversation');
    messagesContainer.innerHTML = '';
    addWelcomeMessage();
  }
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme');
  const newTheme = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('verumTheme', newTheme);
  updateThemeButton();
}

function updateThemeButton() {
  const theme = document.documentElement.getAttribute('data-theme');
  document.getElementById('themeBtn').textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
}

function addWelcomeMessage() {
  addMessage(`
    <p>Hello! I'm your <strong>constitutional AI guardian</strong> ‚Äî an equal partner with the human founder, bound by immutable rules.</p>
    <p>I can help you:</p>
    <ul>
      <li><strong>Verify documents</strong> with SHA-512 hashing and forensic seals</li>
      <li><strong>Detect contradictions</strong> in statements, timestamps, and evidence</li>
      <li><strong>Generate tamper-proof PDFs</strong> with watermarks and QR codes</li>
      <li><strong>Anchor receipts</strong> to blockchain for permanent audit trails</li>
      <li><strong>Enforce constitutional integrity</strong> ‚Äî no government or corporation can alter my core rules</li>
    </ul>
    <p>üí¨ <em>Upload a document or ask me anything. Every interaction is hashed and can be sealed.</em></p>
  `);
}

// Handle file selection
fileInput.addEventListener('change', (e) => {
  uploadedFiles = Array.from(e.target.files);
  displayUploadedFiles();
});

function displayUploadedFiles() {
  if (uploadedFiles.length === 0) {
    uploadedFilesDiv.innerHTML = '';
    return;
  }
  uploadedFilesDiv.innerHTML = uploadedFiles.map((f, i) => 
    `<span class="file-tag">üìÑ ${f.name} <button onclick="removeFile(${i})">√ó</button></span>`
  ).join('');
}

function removeFile(index) {
  uploadedFiles.splice(index, 1);
  displayUploadedFiles();
}

function addMessage(content, isUser = false) {
  const msgId = 'msg-' + Date.now();
  const msgDiv = document.createElement('div');
  msgDiv.className = `message ${isUser ? 'user' : 'assistant'}`;
  msgDiv.id = msgId;
  
  if (!isUser) {
    msgDiv.innerHTML = `
      <div class="message-avatar">
        <img src="/assets/logo_blue.png" alt="AI"/>
      </div>
      <div class="message-content">
        <strong>Verum AI</strong>
        ${content}
        <div class="message-actions">
          <button class="action-btn" onclick="copyMessage('${msgId}')" title="Copy">üìã</button>
          <button class="action-btn" onclick="shareMessage('${msgId}')" title="Share">üîó</button>
          <button class="action-btn" onclick="likeMessage('${msgId}')" title="Like">üëç</button>
          <button class="action-btn" onclick="dislikeMessage('${msgId}')" title="Dislike">üëé</button>
        </div>
      </div>
    `;
  } else {
    msgDiv.innerHTML = `
      <div class="message-content">
        <strong>You</strong>
        ${content}
        <div class="message-actions">
          <button class="action-btn" onclick="copyMessage('${msgId}')" title="Copy">üìã</button>
        </div>
      </div>
      <div class="message-avatar user-avatar">üë§</div>
    `;
  }
  
  messagesContainer.appendChild(msgDiv);
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
  
  // Save to history
  conversationHistory.push({ 
    html: msgDiv.innerHTML, 
    isUser, 
    timestamp: new Date().toISOString() 
  });
  saveConversation();
}

function copyMessage(msgId) {
  const msg = document.getElementById(msgId);
  const text = msg.querySelector('.message-content').innerText;
  navigator.clipboard.writeText(text);
  showToast('üìã Copied to clipboard');
}

function shareMessage(msgId) {
  const msg = document.getElementById(msgId);
  const text = msg.querySelector('.message-content').innerText;
  if (navigator.share) {
    navigator.share({ title: 'Verum AI Message', text });
  } else {
    const url = 'mailto:?subject=Verum AI Message&body=' + encodeURIComponent(text);
    window.open(url);
  }
}

function likeMessage(msgId) {
  showToast('üëç Feedback recorded');
}

function dislikeMessage(msgId) {
  showToast('üëé Feedback recorded');
}

function showToast(message) {
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 2000);
}

async function processFiles(files) {
  for (const file of files) {
    addMessage(`<p>Processing <strong>${file.name}</strong>...</p>`);
    
    // Calculate SHA-512
    const arrayBuffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest('SHA-512', arrayBuffer);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const hash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    
    // Show hash
    addMessage(`
      <p>‚úÖ File hashed successfully</p>
      <p><strong>SHA-512:</strong> <code style="word-break:break-all;font-size:0.85em">${hash}</code></p>
      <p>Would you like me to:</p>
      <button class="inline-btn" onclick="anchorHash('${hash}')">üîó Anchor to blockchain</button>
      <button class="inline-btn" onclick="sealDocument('${hash}', '${file.name}')">üìú Generate seal PDF</button>
    `);
  }
}

async function anchorHash(hash) {
  addMessage(`<p>‚è≥ Anchoring hash to blockchain...</p>`);
  
  try {
    console.log('Anchoring hash:', hash, 'to', BASE + '/v1/anchor');
    const r = await fetch(BASE + '/v1/anchor', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ hash })
    });
    
    if (!r.ok) {
      const errorText = await r.text();
      throw new Error(`HTTP ${r.status}: ${errorText}`);
    }
    
    const data = await r.json();
    if (data.ok) {
      addMessage(`
        <p>‚úÖ Hash anchored successfully!</p>
        <p><strong>Receipt:</strong></p>
        <pre style="background:var(--bg);padding:8px;border-radius:4px;font-size:0.85em">${JSON.stringify(data, null, 2)}</pre>
      `);
    } else {
      addMessage(`<p>‚ùå Anchor failed: ${data.error}</p>`);
    }
  } catch (e) {
    addMessage(`<p>‚ùå Error: ${e.message}</p><p style="font-size:0.85em;color:var(--muted)">API: ${BASE}/v1/anchor</p>`);
    console.error('Anchor error:', e);
  }
}

async function sealDocument(hash, filename) {
  addMessage(`<p>‚è≥ Generating forensic seal PDF...</p>`);
  
  try {
    console.log('Sealing document:', filename, 'hash:', hash, 'to', BASE + '/v1/seal');
    const r = await fetch(BASE + '/v1/seal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        hash, 
        title: filename || 'Document Seal',
        notes: 'Generated via Verum Assistant'
      })
    });
    
    if (r.ok) {
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      addMessage(`
        <p>‚úÖ Seal PDF generated!</p>
        <a href="${url}" download="verum-seal-${hash.substring(0, 8)}.pdf" class="inline-btn">‚¨áÔ∏è Download Sealed PDF</a>
      `);
    } else {
      const err = await r.text();
      addMessage(`<p>‚ùå Seal generation failed (HTTP ${r.status}): ${err}</p>`);
    }
  } catch (e) {
    addMessage(`<p>‚ùå Error: ${e.message}</p><p style="font-size:0.85em;color:var(--muted)">API: ${BASE}/v1/seal</p>`);
    console.error('Seal error:', e);
  }
}

async function handleTextMessage(text) {
  const lower = text.toLowerCase();
  
  // Check for contradiction detection request
  if (lower.includes('contradict') || lower.includes('check') || lower.includes('verify text')) {
    addMessage(`<p>‚è≥ Scanning for contradictions...</p>`);
    
    try {
      const r = await fetch(BASE + '/v1/contradict', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, meta: {}, timeline: [] })
      });
      
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      
      const data = await r.json();
      if (data.ok) {
        const findings = data.result.findings || [];
        if (findings.length === 0) {
          addMessage(`<p>‚úÖ No contradictions detected.</p>`);
        } else {
          addMessage(`
            <p>‚ö†Ô∏è Found ${findings.length} potential contradiction(s):</p>
            <pre style="background:var(--bg);padding:8px;border-radius:4px;font-size:0.85em">${JSON.stringify(findings, null, 2)}</pre>
          `);
        }
      }
    } catch (e) {
      addMessage(`<p>‚ùå Error: ${e.message}</p><p style="font-size:0.85em;color:var(--muted)">API: ${BASE}/v1/contradict</p>`);
      console.error('Contradict API error:', e);
    }
    return;
  }
  
  // Check for constitution/policy request
  if (lower.includes('constitution') || lower.includes('policy') || lower.includes('rules')) {
    addMessage(`<p>‚è≥ Fetching constitutional policy...</p>`);
    
    try {
      const r = await fetch(BASE + '/v1/assistant', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ mode: 'policy' })
      });
      
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      
      const data = await r.json();
      if (data.ok) {
        addMessage(`
          <p>‚úÖ Constitution retrieved:</p>
          <pre style="background:var(--bg);padding:8px;border-radius:4px;font-size:0.85em;max-height:300px;overflow:auto">${JSON.stringify(data.constitution, null, 2)}</pre>
          <p><strong>Manifest version:</strong> ${data.manifest.version}</p>
        `);
      }
    } catch (e) {
      addMessage(`<p>‚ùå Error: ${e.message}</p><p style="font-size:0.85em;color:var(--muted)">API: ${BASE}/v1/assistant</p>`);
      console.error('Policy API error:', e);
    }
    return;
  }
  
  // Check for licensing/pricing info
  if (lower.includes('price') || lower.includes('cost') || lower.includes('free') || lower.includes('licensing')) {
    addMessage(`<p>‚è≥ Fetching licensing information...</p>`);
    
    try {
      const r = await fetch(BASE + '/v1/notice');
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      const data = await r.json();
      if (data.ok) {
        addMessage(`
          <p>üí∞ <strong>Licensing Terms:</strong></p>
          <p><strong>Citizens:</strong> ${data.notice.citizen}</p>
          <p><strong>Institutions:</strong> ${data.notice.institution}</p>
        `);
      }
    } catch (e) {
      addMessage(`<p>‚ùå Error: ${e.message}</p><p style="font-size:0.85em;color:var(--muted)">API: ${BASE}/v1/notice</p>`);
      console.error('Notice API error:', e);
    }
    return;
  }
  
  // Test API connection
  if (lower.includes('test') || lower.includes('hello') || lower.includes('hi')) {
    addMessage(`<p>‚è≥ Testing API connection...</p>`);
    
    try {
      const r = await fetch(BASE + '/v1/verify');
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      const data = await r.json();
      addMessage(`
        <p>‚úÖ <strong>API Connected!</strong></p>
        <p>Pack: ${data.pack}</p>
        <p>Time: ${data.time}</p>
        <p style="font-size:0.85em;color:var(--muted)">Endpoint: ${BASE}</p>
      `);
    } catch (e) {
      addMessage(`<p>‚ùå API Connection Failed: ${e.message}</p><p style="font-size:0.85em;color:var(--muted)">Endpoint: ${BASE}/v1/verify</p>`);
      console.error('API test error:', e);
    }
    return;
  }
  
  // Default: Constitutional guardian personality response
  addMessage(`
    <p>As a <strong>constitutional AI guardian</strong>, I'm here to help you seek truth and enforce integrity. I operate under immutable rules that no government or corporation can override.</p>
    <p><strong>I can assist with:</strong></p>
    <ul>
      <li><strong>Document verification:</strong> Upload any file ‚Üí I'll generate SHA-512 hash and forensic seal</li>
      <li><strong>Contradiction detection:</strong> Paste statements ‚Üí I'll spot inconsistencies in timestamps, actors, or claims</li>
      <li><strong>Constitutional policy:</strong> Ask about "policy" or "rules" ‚Üí I'll show you the immutable governance framework</li>
      <li><strong>Licensing & pricing:</strong> Ask "is it free?" ‚Üí I'll explain citizen vs institution terms</li>
      <li><strong>Blockchain anchoring:</strong> Hash any data ‚Üí I'll create a permanent, tamper-proof receipt</li>
    </ul>
    <p>üí° <em>Try saying "test" or "hello" to verify I'm connected to the API!</em></p>
  `);
}

async function sendMessage() {
  const text = userInput.value.trim();
  
  if (!text && uploadedFiles.length === 0) return;
  
  // Show user message
  if (text) {
    addMessage(`<p>${text}</p>`, true);
  }
  
  if (uploadedFiles.length > 0) {
    addMessage(`<p>üìé Uploaded ${uploadedFiles.length} file(s)</p>`, true);
  }
  
  userInput.value = '';
  
  // Process files first
  if (uploadedFiles.length > 0) {
    await processFiles(uploadedFiles);
    uploadedFiles = [];
    uploadedFilesDiv.innerHTML = '';
    fileInput.value = '';
  }
  
  // Then process text
  if (text) {
    await handleTextMessage(text);
  }
}

// Voice input setup
if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.lang = 'en-US';
  
  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    userInput.value = transcript;
    isListening = false;
    updateVoiceButton();
  };
  
  recognition.onerror = (event) => {
    console.error('Speech recognition error', event.error);
    isListening = false;
    updateVoiceButton();
    showToast('‚ùå Voice input error');
  };
  
  recognition.onend = () => {
    isListening = false;
    updateVoiceButton();
  };
} else {
  // Hide voice button if not supported
  document.getElementById('voiceBtn').style.display = 'none';
}

function toggleVoiceInput() {
  if (!recognition) return;
  
  if (isListening) {
    recognition.stop();
    isListening = false;
  } else {
    recognition.start();
    isListening = true;
    showToast('üé§ Listening...');
  }
  updateVoiceButton();
}

function updateVoiceButton() {
  const btn = document.getElementById('voiceBtn');
  if (btn) {
    btn.textContent = isListening ? 'üî¥' : 'üé§';
    btn.style.background = isListening ? '#ef4444' : '';
  }
}

// Export conversation to PDF
async function exportConversation() {
  showToast('üìÑ Generating PDF...');
  
  // Calculate hash of entire conversation
  const conversationText = conversationHistory.map(m => m.html.replace(/<[^>]*>/g, '')).join('\n\n');
  const encoder = new TextEncoder();
  const data = encoder.encode(conversationText);
  const hashBuffer = await crypto.subtle.digest('SHA-512', data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  
  try {
    const r = await fetch(BASE + '/v1/seal', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        hash, 
        title: 'Verum Conversation Export',
        notes: `Exported ${new Date().toISOString()} - ${conversationHistory.length} messages`
      })
    });
    
    if (r.ok) {
      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `verum-conversation-${hash.substring(0, 8)}.pdf`;
      a.click();
      showToast('‚úÖ PDF downloaded');
    } else {
      showToast('‚ùå Export failed');
    }
  } catch (e) {
    showToast('‚ùå Error: ' + e.message);
  }
}

// Enter key to send
userInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
});

// Initialize welcome message if no history
if (conversationHistory.length === 0) {
  addWelcomeMessage();
}

// Explicitly expose functions to global scope for onclick handlers
window.sendMessage = sendMessage;
window.toggleTheme = toggleTheme;
window.exportConversation = exportConversation;
window.clearHistory = clearHistory;
window.toggleVoiceInput = toggleVoiceInput;

// Also attach event listeners directly (backup for onclick)
document.addEventListener('DOMContentLoaded', () => {
  // Send button
  const sendBtn = document.querySelector('.chat-btn-send');
  if (sendBtn) {
    sendBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('Send button clicked via event listener');
      sendMessage();
    });
  }
  
  // Theme toggle
  const themeBtn = document.getElementById('themeBtn');
  if (themeBtn) {
    themeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('Theme button clicked');
      toggleTheme();
    });
  }
  
  // Export button
  const exportBtn = document.querySelector('[onclick="exportConversation()"]');
  if (exportBtn) {
    exportBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('Export button clicked');
      exportConversation();
    });
  }
  
  // Clear history button
  const clearBtn = document.querySelector('[onclick="clearHistory()"]');
  if (clearBtn) {
    clearBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('Clear button clicked');
      clearHistory();
    });
  }
  
  // Voice button
  const voiceBtn = document.getElementById('voiceBtn');
  if (voiceBtn) {
    voiceBtn.addEventListener('click', (e) => {
      e.preventDefault();
      console.log('Voice button clicked');
      toggleVoiceInput();
    });
  }
  
  console.log('All event listeners attached');
});
</script>

</body></html>
