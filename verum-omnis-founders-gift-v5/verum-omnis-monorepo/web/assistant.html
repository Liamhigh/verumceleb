<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Verum Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-slate-100 max-w-3xl mx-auto p-6">
  <h1 class="text-2xl font-semibold mb-3">Verum Assistant</h1>

  <div class="rounded-xl border border-indigo-600/40 bg-indigo-900/20 p-3 mb-4">
    <div class="text-sm">Initiating analysis under <b>Triple-Lock Verification</b>:</div>
    <ul class="text-sm text-slate-300 list-disc ml-6">
      <li><b>DocHash</b> — we hash locally (SHA-512)</li>
      <li><b>Source-Context</b> — bind file type & case context</li>
      <li><b>Action-Audit</b> — append-only audit trail per claim</li>
    </ul>
  </div>

  <input id="file" type="file" class="mb-4" accept=".pdf,.doc,.docx,.txt,image/*,audio/*,video/*"/>
  <div class="space-x-2 mb-3">
    <button id="btn-verify" class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500">Check this document</button>
    <button id="btn-seal" class="px-3 py-2 rounded border border-slate-700 hover:bg-slate-800">Seal this document</button>
    <button id="btn-anchor" class="px-3 py-2 rounded border border-slate-700 hover:bg-slate-800">Anchor this document</button>
  </div>

  <pre id="out" class="p-3 rounded bg-slate-900 border border-slate-800 whitespace-pre-wrap"></pre>
  <div id="table" class="mt-4"></div>

  <script>
    let currentHash = null;
    let currentFile = null;

    async function sha512(buf){
      const d = await crypto.subtle.digest('SHA-512', buf);
      return [...new Uint8Array(d)].map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    function isSha512(h){ return /^[a-f0-9]{128}$/i.test(h||""); }

    document.getElementById('file').addEventListener('change', async (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      currentFile = f;
      const buf = await f.arrayBuffer();
      const h = await sha512(buf);
      currentHash = h;
      document.getElementById('out').textContent = `I've hashed your file (SHA-512): ${h}\nWhat next?`;
    });

    async function callApi(path, body){
      const res = await fetch('/api' + path, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      const json = await res.json().catch(()=>({error:'non-JSON'}));
      return {status: res.status, json};
    }

    function renderFindings(findings){
      const el = document.getElementById('table');
      if(!findings || !findings.length){ el.innerHTML = ""; return; }
      const rows = findings.map(f => `
        <tr class="border-b border-slate-800">
          <td class="py-2 px-3 font-mono text-xs">${f.id}</td>
          <td class="py-2 px-3">${f.type}</td>
          <td class="py-2 px-3 text-slate-300">${f.span||""}</td>
          <td class="py-2 px-3">${f.consensus}</td>
          <td class="py-2 px-3">${(f.confidence*100).toFixed(0)}%</td>
        </tr>
      `).join("");
      el.innerHTML = `
        <div class="mt-4">
          <h3 class="font-semibold mb-2">Consensus Findings</h3>
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-slate-400">
                <th class="py-1 px-3">ID</th>
                <th class="py-1 px-3">Type</th>
                <th class="py-1 px-3">Span</th>
                <th class="py-1 px-3">Consensus</th>
                <th class="py-1 px-3">Confidence</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    document.getElementById('btn-verify').addEventListener('click', async()=>{
      if(!isSha512(currentHash)) return alert('Upload a file first to compute SHA-512.');
      const r = await callApi('/verify', {
        sha512: currentHash,
        mime: currentFile?.type || null,
        size: currentFile?.size || null
      });
      document.getElementById('out').textContent += `\n\nVerify → ${JSON.stringify(r.json, null, 2)}`;
      renderFindings(r.json?.findings||[]);
    });

    document.getElementById('btn-seal').addEventListener('click', async()=>{
      if(!isSha512(currentHash)) return alert('Upload a file first to compute SHA-512.');
      const r = await callApi('/seal', { sha512: currentHash, filename: currentFile?.name });
      document.getElementById('out').textContent += `\n\nSeal → ${(r.json?.sealed?'sealed':'failed')}`;
      if (r.json?.pdf?.startsWith('base64:')) {
        const b64 = r.json.pdf.slice(7);
        const blob = Uint8Array.from(atob(b64), c=>c.charCodeAt(0));
        const url = URL.createObjectURL(new Blob([blob], {type:'application/pdf'}));
        const a = document.createElement('a');
        a.href = url; a.download = `sealed-${(currentFile?.name||'document')}.pdf`;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 5000);
      }
    });

    document.getElementById('btn-anchor').addEventListener('click', async()=>{
      if(!isSha512(currentHash)) return alert('Upload a file first to compute SHA-512.');
      const r = await callApi('/anchor', { sha512: currentHash });
      document.getElementById('out').textContent += `\n\nAnchor → ${JSON.stringify(r.json, null, 2)}`;
    });
  </script>
</body>
</html>
