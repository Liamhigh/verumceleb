<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Verum Omnis ‚Äî AI Assistant</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Environment config (optional, falls back to dev mode) -->
  <script src="/js/config.js" onerror="console.log('No config.js - using dev mode')"></script>
  <!-- Client-side libraries -->
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
  <!-- PDF.js for PDF text extraction -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <!-- Tesseract.js for OCR -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  
  <!-- Watermark -->
  <img src="/assets/mainlogo.png" alt="Verum Omnis" class="watermark" />
  
  <!-- User Type Selection Modal -->
  <div id="userTypeModal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-sm z-50 flex items-center justify-center p-4">
    <div class="bg-slate-900 rounded-2xl border border-slate-800 max-w-2xl w-full p-8 shadow-2xl">
      <div class="text-center mb-8">
        <h2 class="text-3xl font-bold mb-3">Welcome to Verum Omnis</h2>
        <p class="text-slate-400 text-lg">Please select your account type to continue</p>
      </div>
      
      <div class="grid gap-4 mb-6">
        <!-- Private Person Option -->
        <button 
          onclick="selectUserType('private')"
          class="user-type-btn group p-6 bg-gradient-to-br from-green-900/30 to-green-800/20 border-2 border-green-600/50 hover:border-green-500 rounded-xl transition-all hover:shadow-lg hover:shadow-green-500/20"
        >
          <div class="flex items-center gap-4">
            <div class="text-4xl">üë§</div>
            <div class="flex-1 text-left">
              <h3 class="text-xl font-bold text-green-400 mb-1">Private Person</h3>
              <p class="text-slate-300 text-sm">100% Free Forever</p>
              <p class="text-slate-400 text-xs mt-1">Full access to all features at no cost</p>
            </div>
            <div class="text-green-400">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
          </div>
        </button>
        
        <!-- Institution Option -->
        <button 
          onclick="selectUserType('institution')"
          class="user-type-btn group p-6 bg-gradient-to-br from-indigo-900/30 to-indigo-800/20 border-2 border-indigo-600/50 hover:border-indigo-500 rounded-xl transition-all hover:shadow-lg hover:shadow-indigo-500/20"
        >
          <div class="flex items-center gap-4">
            <div class="text-4xl">üèõÔ∏è</div>
            <div class="flex-1 text-left">
              <h3 class="text-xl font-bold text-indigo-400 mb-1">Institution</h3>
              <p class="text-slate-300 text-sm">Banks, Law Firms, Courts</p>
              <p class="text-slate-400 text-xs mt-1">Free trial, then 20% of recovered fraud</p>
            </div>
            <div class="text-indigo-400">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
          </div>
        </button>
        
        <!-- Company Option -->
        <button 
          onclick="selectUserType('company')"
          class="user-type-btn group p-6 bg-gradient-to-br from-purple-900/30 to-purple-800/20 border-2 border-purple-600/50 hover:border-purple-500 rounded-xl transition-all hover:shadow-lg hover:shadow-purple-500/20"
        >
          <div class="flex items-center gap-4">
            <div class="text-4xl">üè¢</div>
            <div class="flex-1 text-left">
              <h3 class="text-xl font-bold text-purple-400 mb-1">Company</h3>
              <p class="text-slate-300 text-sm">Businesses & Enterprises</p>
              <p class="text-slate-400 text-xs mt-1">Free trial, then 20% of recovered fraud or licensing</p>
            </div>
            <div class="text-purple-400">
              <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
            </div>
          </div>
        </button>
      </div>
      
      <p class="text-center text-xs text-slate-500">
        You can change this selection anytime in settings
      </p>
    </div>
  </div>
  
  <!-- Fee Notice Modal (for Institution/Company) -->
  <div id="feeNoticeModal" class="fixed inset-0 bg-slate-950/95 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="bg-slate-900 rounded-2xl border border-slate-800 max-w-2xl w-full p-8 shadow-2xl">
      <div class="text-center mb-6">
        <div class="text-5xl mb-4">‚öñÔ∏è</div>
        <h2 class="text-3xl font-bold mb-3">Important Notice</h2>
      </div>
      
      <div class="bg-yellow-900/20 border-2 border-yellow-600/50 rounded-xl p-6 mb-6">
        <h3 class="text-xl font-bold text-yellow-400 mb-4">Pricing & Terms</h3>
        <div class="space-y-3 text-slate-300">
          <p class="leading-relaxed">
            <strong>Free Trial Period:</strong> You can use Verum Omnis free during your trial period with full access to all features.
          </p>
          <p class="leading-relaxed">
            <strong>After Trial:</strong> A <span class="text-yellow-400 font-semibold">20% fee applies to recovered fraud</span> or a <span class="text-yellow-400 font-semibold">licensing subscription</span> for ongoing fraud prevention.
          </p>
          <p class="leading-relaxed text-sm">
            This success-based pricing ensures you only pay when we help you recover funds or prevent fraud. No upfront costs, no hidden fees.
          </p>
        </div>
      </div>
      
      <div class="mb-6">
        <label class="flex items-start gap-3 cursor-pointer">
          <input type="checkbox" id="agreeTerms" class="mt-1 w-5 h-5 rounded border-slate-700 bg-slate-800 text-indigo-600 focus:ring-indigo-500">
          <span class="text-sm text-slate-300">
            I understand and agree to the pricing terms. I acknowledge that after the free trial period, fees will apply based on recovered fraud or licensing for ongoing use.
          </span>
        </label>
      </div>
      
      <div class="flex gap-3">
        <button 
          onclick="goBack()"
          class="flex-1 px-6 py-3 border border-slate-700 hover:bg-slate-800 rounded-lg font-medium transition-colors"
        >
          Go Back
        </button>
        <button 
          id="acceptTermsBtn"
          onclick="acceptTerms()"
          class="flex-1 px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          disabled
        >
          Accept & Continue
        </button>
      </div>
    </div>
  </div>
  
  <!-- Header -->
  <header class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between flex-wrap gap-4">
      <div class="flex items-center gap-3">
        <img src="/assets/mainlogo.png" alt="Verum Omnis ‚Äî the whole truth" class="h-16 object-contain" />
      </div>
      <nav class="flex gap-3 flex-wrap">
        <a href="/" class="px-3 py-2 rounded border border-slate-700 hover:bg-slate-800 text-sm">Home</a>
        <a href="/institutions.html" class="px-3 py-2 rounded border border-slate-700 hover:bg-slate-800 text-sm">Institutions</a>
        <a href="/legal.html" class="px-3 py-2 rounded border border-slate-700 hover:bg-slate-800 text-sm">Legal</a>
        <a href="/tax.html" class="px-3 py-2 rounded border border-slate-700 hover:bg-slate-800 text-sm">Tax</a>
      </nav>
    </div>
  </header>

  <!-- Main: 2-column layout (chat + tools) -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="grid md:grid-cols-[1fr_350px] gap-6">
      
      <!-- LEFT: Chat Interface (70%) -->
      <div class="flex flex-col h-[calc(100vh-200px)]">
        <div class="bg-slate-900 rounded-2xl border border-slate-800 flex flex-col h-full">
          <!-- Chat header -->
          <div class="p-4 border-b border-slate-800">
            <h2 class="text-xl font-semibold">Chat Assistant</h2>
            <p class="text-sm text-slate-400">Ask me anything or use the tools ‚Üí</p>
          </div>
          
          <!-- Chat messages -->
          <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3">
            <!-- Initial message -->
            <div class="flex gap-3">
              <div class="flex-shrink-0 w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-sm">
                AI
              </div>
              <div class="flex-1 bg-slate-800 rounded-2xl rounded-tl-sm p-3">
                <p class="text-slate-100">Hi ‚Äî I'm your Verum Omnis assistant. We can chat normally, and I can Verify, Seal, and Anchor documents. Drop a file anytime.</p>
              </div>
            </div>
          </div>
          
          <!-- Typing indicator (hidden by default) -->
          <div id="typingIndicator" class="px-4 pb-2 hidden">
            <div class="flex gap-3">
              <div class="flex-shrink-0 w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-sm">
                AI
              </div>
              <div class="bg-slate-800 rounded-2xl rounded-tl-sm px-4 py-2">
                <div class="flex gap-1">
                  <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce"></div>
                  <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                  <div class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Chat input -->
          <div class="p-4 border-t border-slate-800">
            <form id="chatForm" class="flex gap-2">
              <input 
                type="text" 
                id="chatInput" 
                placeholder="Type a message..." 
                class="flex-1 px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg focus:outline-none focus:border-indigo-500"
                autocomplete="off"
              />
              <button 
                type="submit" 
                class="px-6 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium transition-colors"
              >
                Send
              </button>
            </form>
          </div>
        </div>
      </div>
      
      <!-- RIGHT: Tools Panel (30%) -->
      <div class="space-y-4">
        <!-- File Upload Card -->
        <div class="bg-slate-900 rounded-2xl border border-slate-800 p-5">
          <h3 class="font-semibold mb-3 flex items-center gap-2">
            <span class="text-xl">üìÅ</span>
            Document Tools
          </h3>
          
          <!-- File Input -->
          <label class="block mb-4">
            <span class="text-sm text-slate-400 mb-2 block">Select File</span>
            <input 
              type="file" 
              id="fileInput" 
              accept=".pdf,.doc,.docx,.txt,.png,.jpg,.jpeg,.mp3,.mp4"
              class="block w-full text-sm text-slate-400
                file:mr-4 file:py-2 file:px-4
                file:rounded file:border-0
                file:text-sm file:font-semibold
                file:bg-indigo-600 file:text-white
                hover:file:bg-indigo-500
                file:cursor-pointer cursor-pointer"
            />
          </label>
          
          <!-- File Info -->
          <div id="fileInfo" class="mb-4 p-3 bg-slate-800 rounded-lg text-sm hidden">
            <div class="text-slate-400 mb-1">File loaded:</div>
            <div id="fileName" class="font-medium text-slate-200 truncate"></div>
            <div id="fileSize" class="text-slate-500 text-xs"></div>
          </div>
          
          <!-- Hash Display -->
          <div id="hashDisplay" class="mb-4 hidden">
            <label class="text-sm text-slate-400 mb-2 block">SHA-512 Hash</label>
            <div class="relative">
              <input 
                type="text" 
                id="hashValue" 
                readonly 
                class="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-xs font-mono text-slate-300 pr-20"
              />
              <button 
                id="copyHash" 
                class="absolute right-2 top-1/2 -translate-y-1/2 px-3 py-1 bg-slate-700 hover:bg-slate-600 rounded text-xs transition-colors"
              >
                Copy
              </button>
            </div>
            <div id="hashTruncated" class="text-xs text-slate-500 mt-1"></div>
          </div>
          
          <!-- Action Buttons -->
          <div class="space-y-2">
            <button 
              id="btnVerify" 
              class="w-full px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              üîç Check this document
            </button>
            
            <button 
              id="btnSeal" 
              class="w-full px-4 py-2 border border-slate-700 hover:bg-slate-800 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              üîí Seal this document
            </button>
            
            <button 
              id="btnAnchor" 
              class="w-full px-4 py-2 border border-slate-700 hover:bg-slate-800 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              disabled
            >
              ‚öì Anchor this document
            </button>
          </div>
        </div>
        
        <!-- Results Card (hidden by default) -->
        <div id="resultsCard" class="bg-slate-900 rounded-2xl border border-slate-800 p-5 hidden">
          <h3 class="font-semibold mb-3">Results</h3>
          <div id="resultsContent" class="text-sm space-y-2"></div>
        </div>
      </div>
      
    </div>
  </main>

  <!-- Watermark Styles -->
  <style>
    .watermark {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      opacity: 0.05;
      pointer-events: none;
      z-index: 0;
      max-width: 800px;
      width: 60%;
    }
    
    header, main {
      position: relative;
      z-index: 1;
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-0.5rem); }
    }
    
    .animate-bounce {
      animation: bounce 1s infinite;
    }
  </style>

  <!-- User Type Modal Script (non-module, runs first) -->
  <script>
    // User type selection modal functions
    window.selectUserType = function(type) {
      if (type === 'private') {
        // Private person - no fee notice needed
        localStorage.setItem('verumUserType', 'private');
        document.getElementById('userTypeModal').classList.add('hidden');
      } else {
        // Institution or Company - show fee notice
        localStorage.setItem('verumUserTypeTemp', type);
        document.getElementById('userTypeModal').classList.add('hidden');
        const feeNoticeModal = document.getElementById('feeNoticeModal');
        feeNoticeModal.classList.remove('hidden');
        feeNoticeModal.classList.add('flex');
      }
    };
    
    window.goBack = function() {
      const feeNoticeModal = document.getElementById('feeNoticeModal');
      feeNoticeModal.classList.add('hidden');
      feeNoticeModal.classList.remove('flex');
      document.getElementById('userTypeModal').classList.remove('hidden');
      document.getElementById('agreeTerms').checked = false;
      document.getElementById('acceptTermsBtn').disabled = true;
    };
    
    window.acceptTerms = function() {
      const userType = localStorage.getItem('verumUserTypeTemp');
      localStorage.setItem('verumUserType', userType);
      localStorage.removeItem('verumUserTypeTemp');
      
      const feeNoticeModal = document.getElementById('feeNoticeModal');
      feeNoticeModal.classList.add('hidden');
      feeNoticeModal.classList.remove('flex');
    };
    
    // Check if user type is already selected
    function checkUserType() {
      const userType = localStorage.getItem('verumUserType');
      if (userType) {
        // User type already selected, hide modal
        document.getElementById('userTypeModal').classList.add('hidden');
      }
    }
    
    // Enable/disable accept button based on checkbox
    document.addEventListener('DOMContentLoaded', function() {
      checkUserType();
      
      const agreeCheckbox = document.getElementById('agreeTerms');
      if (agreeCheckbox) {
        agreeCheckbox.addEventListener('change', function(e) {
          document.getElementById('acceptTermsBtn').disabled = !e.target.checked;
        });
      }
    });
  </script>

  <!-- Main Application Script -->
  <script type="module">
    import { 
      computeSHA512, 
      verifyTriple, 
      sealPDF, 
      anchor, 
      assistantReply,
      truncateHash,
      getCurrentFile
    } from '/js/assistant.js';

    // ========================================================================
    // STATE
    // ========================================================================
    let currentFileData = null;

    // ========================================================================
    // DOM ELEMENTS
    // ========================================================================
    const elements = {
      fileInput: document.getElementById('fileInput'),
      fileInfo: document.getElementById('fileInfo'),
      fileName: document.getElementById('fileName'),
      fileSize: document.getElementById('fileSize'),
      hashDisplay: document.getElementById('hashDisplay'),
      hashValue: document.getElementById('hashValue'),
      hashTruncated: document.getElementById('hashTruncated'),
      copyHash: document.getElementById('copyHash'),
      btnVerify: document.getElementById('btnVerify'),
      btnSeal: document.getElementById('btnSeal'),
      btnAnchor: document.getElementById('btnAnchor'),
      resultsCard: document.getElementById('resultsCard'),
      resultsContent: document.getElementById('resultsContent'),
      chatMessages: document.getElementById('chatMessages'),
      chatForm: document.getElementById('chatForm'),
      chatInput: document.getElementById('chatInput'),
      typingIndicator: document.getElementById('typingIndicator')
    };

    // ========================================================================
    // FILE HANDLING
    // ========================================================================
    elements.fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      try {
        // Show loading state
        showResults('Computing hash...', 'info');
        enableButtons(false);

        // Compute hash
        const hashData = await computeSHA512(file);
        currentFileData = hashData;

        // Update UI
        elements.fileName.textContent = hashData.filename;
        elements.fileSize.textContent = `${(hashData.size / 1024).toFixed(1)} KB`;
        elements.fileInfo.classList.remove('hidden');

        elements.hashValue.value = hashData.sha512;
        elements.hashTruncated.textContent = `Truncated: ${truncateHash(hashData.sha512)}`;
        elements.hashDisplay.classList.remove('hidden');

        // Enable buttons
        enableButtons(true);

        // Hide results
        elements.resultsCard.classList.add('hidden');

        // Add message to chat
        addAssistantMessage(`File loaded: "${hashData.filename}" (${(hashData.size / 1024).toFixed(1)}KB). Hash computed successfully! ‚úì`);

      } catch (error) {
        showResults(`Error: ${error.message}`, 'error');
        console.error(error);
      }
    });

    // ========================================================================
    // DRAG AND DROP FILE UPLOAD
    // ========================================================================
    const fileUploadZone = elements.fileInput.parentElement;
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      fileUploadZone.addEventListener(eventName, preventDefaults, false);
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
      fileUploadZone.addEventListener(eventName, () => {
        fileUploadZone.classList.add('border-indigo-500', 'bg-indigo-900/30');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      fileUploadZone.addEventListener(eventName, () => {
        fileUploadZone.classList.remove('border-indigo-500', 'bg-indigo-900/30');
      }, false);
    });

    fileUploadZone.addEventListener('drop', async (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;

      if (files.length > 0) {
        const file = files[0];
        // Trigger file processing
        elements.fileInput.files = files;
        elements.fileInput.dispatchEvent(new Event('change'));
      }
    }, false);

    // ========================================================================
    // COPY HASH
    // ========================================================================
    elements.copyHash.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(elements.hashValue.value);
        elements.copyHash.textContent = 'Copied!';
        setTimeout(() => {
          elements.copyHash.textContent = 'Copy';
        }, 2000);
      } catch (error) {
        alert('Failed to copy hash');
      }
    });

    // ========================================================================
    // VERIFY BUTTON - Nine-Brains Forensic Analysis
    // ========================================================================
    elements.btnVerify.addEventListener('click', async () => {
      if (!currentFileData) return;

      try {
        elements.btnVerify.disabled = true;
        elements.btnVerify.textContent = '‚è≥ Analyzing with Nine-Brains...';
        showResults('Running forensic verification with 9 independent analysis modules...', 'info');

        const verification = await verifyTriple({
          arrayBuffer: currentFileData.arrayBuffer,
          sha512: currentFileData.sha512,
          filename: currentFileData.filename,
          mime: currentFileData.mime
        });

        // Get Nine-Brains results
        const nineBrains = verification.nineBrainsResults || verification;
        
        // Build Nine-Brains matrix display
        let html = `
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div class="font-bold text-xl">Nine-Brains Forensic Analysis</div>
              <div class="text-sm text-slate-400">
                Score: ${Math.round((nineBrains.avgScore || 0) * 100)}%
              </div>
            </div>
            
            <!-- Consensus Banner -->
            <div class="p-4 rounded-lg ${nineBrains.consensus === 'pass' ? 'bg-green-900/30 border-2 border-green-600' : 'bg-red-900/30 border-2 border-red-600'}">
              <div class="flex items-center gap-3">
                <div class="text-3xl">${nineBrains.consensus === 'pass' ? '‚úÖ' : 'üö®'}</div>
                <div>
                  <div class="font-bold text-lg ${nineBrains.consensus === 'pass' ? 'text-green-400' : 'text-red-400'}">
                    ${nineBrains.consensus === 'pass' ? 'PASS - Document Verified' : 'FLAG - Review Required'}
                  </div>
                  <div class="text-sm text-slate-300">
                    ${nineBrains.passCount || 0} of 9 brains voted PASS (${nineBrains.flagCount || 0} flagged)
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Nine-Brains Results Table -->
            <div class="overflow-x-auto">
              <table class="w-full text-sm border-collapse">
                <thead>
                  <tr class="border-b border-slate-700 bg-slate-800/50">
                    <th class="text-left py-2 px-3 font-semibold">Brain Module</th>
                    <th class="text-center py-2 px-2 font-semibold">Vote</th>
                    <th class="text-center py-2 px-2 font-semibold">Score</th>
                    <th class="text-left py-2 px-3 font-semibold">Key Findings</th>
                  </tr>
                </thead>
                <tbody>
        `;

        const results = nineBrains.results || verification.results || [];
        results.forEach((brain, i) => {
          const voteColor = brain.vote === 'pass' ? 'text-green-400' : 'text-red-400';
          const voteIcon = brain.vote === 'pass' ? '‚úì' : '‚ö†Ô∏è';
          const scorePercent = Math.round((brain.score || 0) * 100);
          const scoreColor = scorePercent >= 70 ? 'text-green-400' : scorePercent >= 40 ? 'text-yellow-400' : 'text-red-400';
          
          html += `
            <tr class="border-b border-slate-800 hover:bg-slate-800/30">
              <td class="py-3 px-3">
                <div class="font-medium">${brain.brain || brain.checker || `Brain ${i+1}`}</div>
              </td>
              <td class="py-3 px-2 text-center ${voteColor} font-bold text-lg">
                ${voteIcon}
              </td>
              <td class="py-3 px-2 text-center ${scoreColor} font-mono text-xs">
                ${scorePercent}%
              </td>
              <td class="py-3 px-3 text-xs text-slate-300">
                ${(brain.notes || []).slice(0, 3).map(n => `<div class="mb-1">‚Ä¢ ${n}</div>`).join('')}
                ${brain.notes && brain.notes.length > 3 ? `<div class="text-slate-500 italic">+${brain.notes.length - 3} more...</div>` : ''}
              </td>
            </tr>
          `;
        });

        html += `
                </tbody>
              </table>
            </div>
            
            <!-- Recommendation -->
            <div class="p-3 bg-slate-800/50 rounded-lg border border-slate-700">
              <div class="font-semibold mb-2">üí° Recommendation:</div>
              <div class="text-sm text-slate-300">
                ${nineBrains.consensus === 'pass' 
                  ? 'Document passed forensic verification. You can proceed with sealing and anchoring for court submission.'
                  : 'Document has been flagged. Review the findings above carefully. Consider requesting original source or additional documentation.'}
              </div>
            </div>
          </div>
        `;

        showResults(html, nineBrains.consensus === 'pass' ? 'success' : 'warning');
        
        // Add conversational assistant message
        const msg = nineBrains.consensus === 'pass' 
          ? `‚úÖ Great news! Your document "${currentFileData.filename}" passed all forensic checks. Out of 9 independent verification modules, ${nineBrains.passCount} voted PASS. The document appears authentic and ready for legal use. Would you like me to seal it with a certified QR code?`
          : `‚ö†Ô∏è I've analyzed "${currentFileData.filename}" and ${nineBrains.flagCount} out of 9 verification modules raised concerns. This doesn't necessarily mean the document is fake, but it warrants careful review. Check the detailed findings above. Would you like me to explain what any of the modules found?`;
        
        addAssistantMessage(msg);

      } catch (error) {
        showResults(`Verification failed: ${error.message}`, 'error');
        addAssistantMessage(`I encountered an error while analyzing the document: ${error.message}. This might happen if the file type isn't fully supported yet. Try a PDF or image file.`);
      } finally {
        elements.btnVerify.disabled = false;
        elements.btnVerify.textContent = 'üîç Check this document';
      }
    });    // ========================================================================
    // SEAL BUTTON
    // ========================================================================
    elements.btnSeal.addEventListener('click', async () => {
      if (!currentFileData) return;

      try {
        elements.btnSeal.disabled = true;
        elements.btnSeal.textContent = '‚è≥ Sealing...';
        showResults('Generating sealed PDF...', 'info');

        const fileData = getCurrentFile();
        const sealed = await sealPDF({
          arrayBuffer: fileData.arrayBuffer,
          sha512: fileData.sha512,
          filename: fileData.filename
        });

        // Create download link
        const url = URL.createObjectURL(sealed.blob);
        const html = `
          <div class="space-y-3">
            <div class="p-3 bg-green-900/30 border border-green-700 rounded-lg">
              <div class="font-medium text-green-400 mb-2">‚úì PDF Sealed Successfully</div>
              <div class="text-sm text-slate-300">
                <div>File: ${sealed.filename}</div>
                <div>Size: ${(sealed.size / 1024).toFixed(1)} KB</div>
              </div>
            </div>
            <a 
              href="${url}" 
              download="${sealed.filename}"
              class="block w-full px-4 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-center font-medium transition-colors"
            >
              üì• Download ${sealed.filename}
            </a>
          </div>
        `;

        showResults(html, 'success');
        addAssistantMessage(`Your sealed PDF is ready! Click the download button in the results panel. The PDF includes the Verum Omnis watermark, truncated hash, and QR code for verification.`);

      } catch (error) {
        showResults(`Sealing failed: ${error.message}`, 'error');
        addAssistantMessage(`Sorry, PDF sealing encountered an error: ${error.message}`);
      } finally {
        elements.btnSeal.disabled = false;
        elements.btnSeal.textContent = 'üîí Seal this document';
      }
    });

    // ========================================================================
    // ANCHOR BUTTON
    // ========================================================================
    elements.btnAnchor.addEventListener('click', async () => {
      if (!currentFileData) return;

      try {
        elements.btnAnchor.disabled = true;
        elements.btnAnchor.textContent = '‚è≥ Anchoring...';
        showResults('Generating anchor receipt...', 'info');

        const receipt = await anchor({
          sha512: currentFileData.sha512,
          filename: currentFileData.filename
        });

        // Create downloadable receipt
        const receiptBlob = new Blob([JSON.stringify(receipt, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(receiptBlob);

        let html = `
          <div class="space-y-3">
            <div class="p-3 bg-blue-900/30 border border-blue-700 rounded-lg">
              <div class="font-medium text-blue-400 mb-2">‚öì Anchor Receipt Generated</div>
              <div class="text-xs text-slate-300 space-y-1">
                <div><strong>Method:</strong> ${receipt.method}</div>
                <div><strong>Timestamp:</strong> ${receipt.timestamp}</div>
                ${receipt.txHash ? `<div><strong>Tx Hash:</strong> ${receipt.txHash.substring(0, 20)}...</div>` : ''}
                ${receipt.note ? `<div class="text-yellow-400">${receipt.note}</div>` : ''}
              </div>
            </div>
            <a 
              href="${url}" 
              download="anchor-receipt.json"
              class="block w-full px-4 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-center font-medium transition-colors"
            >
              ÔøΩÔøΩ Download anchor-receipt.json
            </a>
          </div>
        `;

        showResults(html, 'success');
        addAssistantMessage(`Anchor receipt created! Download the JSON file to keep a permanent record of your document's hash and timestamp.`);

      } catch (error) {
        showResults(`Anchoring failed: ${error.message}`, 'error');
        addAssistantMessage(`Sorry, anchoring encountered an error: ${error.message}`);
      } finally {
        elements.btnAnchor.disabled = false;
        elements.btnAnchor.textContent = '‚öì Anchor this document';
      }
    });

    // ========================================================================
    // CHAT FUNCTIONALITY
    // ========================================================================
    elements.chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const message = elements.chatInput.value.trim();
      if (!message) return;

      // Add user message
      addUserMessage(message);
      elements.chatInput.value = '';

      // Show typing indicator
      elements.typingIndicator.classList.remove('hidden');
      scrollChatToBottom();

      try {
        // Small delay for natural feel
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Get assistant reply
        const reply = await assistantReply(message);

        // Hide typing indicator
        elements.typingIndicator.classList.add('hidden');

        // Add assistant message
        addAssistantMessage(reply);

      } catch (error) {
        elements.typingIndicator.classList.add('hidden');
        addAssistantMessage('I apologize, but I encountered an error processing your message.');
        console.error(error);
      }
    });

    function addUserMessage(text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex gap-3 justify-end';
      messageDiv.innerHTML = `
        <div class="bg-indigo-600 rounded-2xl rounded-tr-sm p-3 max-w-[80%]">
          <p class="text-slate-100">${escapeHtml(text)}</p>
        </div>
        <div class="flex-shrink-0 w-8 h-8 bg-slate-700 rounded-full flex items-center justify-center text-sm">
          U
        </div>
      `;
      elements.chatMessages.appendChild(messageDiv);
      scrollChatToBottom();
    }

    function addAssistantMessage(text) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'flex gap-3';
      messageDiv.innerHTML = `
        <div class="flex-shrink-0 w-8 h-8 bg-indigo-600 rounded-full flex items-center justify-center text-sm">
          AI
        </div>
        <div class="flex-1 bg-slate-800 rounded-2xl rounded-tl-sm p-3 max-w-[80%]">
          <p class="text-slate-100 whitespace-pre-wrap">${escapeHtml(text)}</p>
        </div>
      `;
      elements.chatMessages.appendChild(messageDiv);
      scrollChatToBottom();
    }

    function scrollChatToBottom() {
      elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ========================================================================
    // HELPERS
    // ========================================================================
    function enableButtons(enabled) {
      elements.btnVerify.disabled = !enabled;
      elements.btnSeal.disabled = !enabled;
      elements.btnAnchor.disabled = !enabled;
    }

    function showResults(content, type = 'info') {
      elements.resultsContent.innerHTML = content;
      elements.resultsCard.classList.remove('hidden');
    }

    // ========================================================================
    // INITIALIZE
    // ========================================================================
    console.log('Verum Omnis Assistant loaded - all features client-side ‚úì');
    
    // Check for optional configurations
    if (window.VERUM_ENV?.OPENAI_API_KEY) {
      console.log('LLM integration detected');
    }
    if (window.VERUM_ENV?.ANCHOR) {
      console.log('Blockchain anchoring configured:', window.VERUM_ENV.ANCHOR);
    }
  </script>
</body>
</html>
